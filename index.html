<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>업무포털</title>

<style>

body{font-family:Arial;margin:0;background:#f4f6fb;}

header{
background:#1f2a44;
color:white;
padding:14px;
font-size:20px;
font-weight:bold;
display:flex;
justify-content:space-between;
align-items:center;
}

.container{padding:20px;}

.board{display:flex;gap:20px;overflow-x:auto;}

.column{
background:white;
border-radius:10px;
padding:15px;
width:320px;
box-shadow:0 3px 10px rgba(0,0,0,0.1);
}

.card{
background:#f1f3f8;
padding:10px;
border-radius:8px;
margin-bottom:10px;
}

button{
border:none;
padding:6px 10px;
border-radius:6px;
cursor:pointer;
}

.addTask{background:#2b7cff;color:white;}
.move{background:#22c55e;color:white;}
.back{background:#f59e0b;color:white;}
.delete{background:#ef4444;color:white;}
.logout{background:#111;color:white;}

.loginBox{
max-width:400px;
margin:80px auto;
background:white;
padding:30px;
border-radius:10px;
box-shadow:0 5px 20px rgba(0,0,0,0.1);
}

input{
width:100%;
padding:10px;
margin-bottom:10px;
}

.notice{
background:white;
padding:10px;
margin-bottom:15px;
border-radius:8px;
}

</style>
</head>

<body>

<header>
<div>
업무포털 <span id="adminTag"></span>
</div>

<div id="logoutArea"></div>
</header>

<div id="login" class="loginBox">

<h2>로그인</h2>

<input id="email" placeholder="이메일">
<input id="password" type="password" placeholder="비밀번호">

<button onclick="login()">로그인</button>

<hr>

<h3>회원가입</h3>

<input id="name" placeholder="이름">
<input id="joinEmail" placeholder="이메일">
<input id="joinPassword" type="password" placeholder="비밀번호">

<button onclick="signup()">가입</button>

</div>

<div id="appArea" style="display:none">

<div class="container">

<div id="adminArea"></div>

<div id="noticeArea"></div>

<div class="board">

<div class="column">
<h2>진행중</h2>
<div id="todo"></div>
</div>

<div class="column">
<h2>완료</h2>
<div id="done"></div>
</div>

</div>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getAuth,
signInWithEmailAndPassword,
createUserWithEmailAndPassword,
onAuthStateChanged,
signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
getFirestore,
collection,
addDoc,
doc,
getDoc,
setDoc,
updateDoc,
deleteDoc,
onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyC6t4mzE936TCxWNdN9VbS5m-YT-kCXjyw",
authDomain: "task-f5475.firebaseapp.com",
projectId: "task-f5475",
storageBucket: "task-f5475.firebasestorage.app",
messagingSenderId: "466794970732",
appId: "1:466794970732:web:7eef2350e6d638dd6da249"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginBox=document.getElementById("login");
const appArea=document.getElementById("appArea");
const logoutArea=document.getElementById("logoutArea");

const emailInput=document.getElementById("email");
const passwordInput=document.getElementById("password");

const joinEmail=document.getElementById("joinEmail");
const joinPassword=document.getElementById("joinPassword");
const nameInput=document.getElementById("name");

let myData=null;

window.login=async()=>{

try{
await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
}catch(e){
alert(e.message);
}

}

window.signup=async()=>{

try{

const cred=await createUserWithEmailAndPassword(
auth,
joinEmail.value,
joinPassword.value
);

await setDoc(doc(db,"users",cred.user.uid),{

email:joinEmail.value,
name:nameInput.value,
role:"staff",
approved:false

});

alert("가입 완료 / 관리자 승인 필요");

}catch(e){
alert(e.message);
}

}

onAuthStateChanged(auth,async(user)=>{

if(!user){

loginBox.style.display="block";
appArea.style.display="none";
logoutArea.innerHTML="";
return;

}

const snap=await getDoc(doc(db,"users",user.uid));

myData=snap.data();

if(!myData || !myData.approved){

alert("관리자 승인 대기");
await signOut(auth);
return;

}

startApp();

});

function startApp(){

loginBox.style.display="none";
appArea.style.display="block";

logoutArea.innerHTML=`<button class="logout" onclick="logout()">로그아웃</button>`;

if(myData.role==="admin"){
adminTag.innerText="관리자";
renderAdmin();
}

loadTasks();
loadNotice();

}

window.logout=async()=>{
await signOut(auth);
location.reload();
}

function renderAdmin(){

adminArea.innerHTML=`

<button class="addTask" onclick="addTask()">업무추가</button>
<button onclick="addNotice()">공지작성</button>

`;

}

window.addTask=async()=>{

const text=prompt("업무");

if(!text) return;

await addDoc(collection(db,"tasks"),{

text,
status:"todo",
created:new Date()

});

}

window.addNotice=async()=>{

const text=prompt("공지");

if(!text) return;

await addDoc(collection(db,"notice"),{

text,
date:new Date()

});

}

function loadTasks(){

onSnapshot(collection(db,"tasks"),snap=>{

todo.innerHTML="";
done.innerHTML="";

snap.forEach(d=>{

const data=d.data();
const id=d.id;

const div=document.createElement("div");
div.className="card";
div.innerHTML=data.text+"<br>";

if(data.status==="todo"){

div.innerHTML+=`<button class="move" onclick="move('${id}','done')">완료</button>`;
todo.appendChild(div);

}

if(data.status==="done"){

div.innerHTML+=`
<button class="back" onclick="move('${id}','todo')">복귀</button>
<button class="delete" onclick="removeTask('${id}')">삭제</button>
`;

done.appendChild(div);

}

});

});

}

window.move=async(id,st)=>{
await updateDoc(doc(db,"tasks",id),{status:st});
}

window.removeTask=async(id)=>{
await deleteDoc(doc(db,"tasks",id));
}

function loadNotice(){

onSnapshot(collection(db,"notice"),snap=>{

noticeArea.innerHTML="";

snap.forEach(n=>{

const d=n.data();

const div=document.createElement("div");
div.className="notice";
div.innerText=d.text;

noticeArea.appendChild(div);

});

});

}

</script>

</body>
</html>
