<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>업무현황파악</title>

<style>

body{
font-family:Arial;
margin:0;
background:#f4f6fb;
}

header{
background:#1f2a44;
color:white;
padding:14px;
font-size:20px;
font-weight:bold;
display:flex;
justify-content:space-between;
align-items:center;
}

.container{
padding:20px;
}

.board{
display:flex;
gap:20px;
overflow-x:auto;
}

.column{
background:white;
border-radius:10px;
padding:15px;
width:320px;
box-shadow:0 3px 10px rgba(0,0,0,0.1);
min-height:400px;
}

.card{
background:#eef1f8;
padding:10px;
border-radius:8px;
margin-bottom:10px;
cursor:grab;
}

button{
border:none;
padding:6px 10px;
border-radius:6px;
cursor:pointer;
background:#1f2a44;
color:white;
}

.loginBox{
max-width:400px;
margin:80px auto;
background:white;
padding:30px;
border-radius:10px;
box-shadow:0 5px 20px rgba(0,0,0,0.1);
}

input,select{
width:100%;
padding:10px;
margin-bottom:10px;
}

.notice{
background:white;
padding:10px;
margin-bottom:10px;
border-radius:8px;
}

.adminTag{
background:#111827;
padding:4px 8px;
border-radius:6px;
margin-left:10px;
font-size:12px;
}

.modal{
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
background:rgba(0,0,0,0.4);
display:flex;
align-items:center;
justify-content:center;
}

.modalBox{
background:white;
padding:20px;
border-radius:10px;
width:320px;
}

</style>
</head>

<body>

<header>
<div>
업무현황파악
<span id="adminTag"></span>
</div>
<div id="logoutArea"></div>
</header>

<div id="login" class="loginBox">

<h2>로그인</h2>

<input id="email" placeholder="이메일">
<input id="password" type="password" placeholder="비밀번호">
<button onclick="login()">로그인</button>

<hr>

<h3>회원가입</h3>

<input id="userName" placeholder="이름">
<input id="joinEmail" placeholder="이메일">
<input id="joinPassword" type="password" placeholder="비밀번호">
<button onclick="signup()">가입</button>

</div>

<div id="appArea" style="display:none">

<div class="container">

<div id="adminPanel"></div>

<h3>공지</h3>
<div id="noticeArea"></div>

<div class="board">

<div class="column" data-status="todo">
<h2>진행</h2>
<div id="todo"></div>
</div>

<div class="column" data-status="done">
<h2>완료</h2>
<div id="done"></div>
</div>

</div>

</div>
</div>

<div id="taskModal" style="display:none" class="modal">
<div class="modalBox">

<h3>업무 추가</h3>

<input id="taskText" placeholder="업무 내용">
<select id="staffSelect"></select>

<button onclick="createTask()">등록</button>
<button onclick="closeModal()">취소</button>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getAuth,
signInWithEmailAndPassword,
createUserWithEmailAndPassword,
onAuthStateChanged,
signOut,
setPersistence,
browserSessionPersistence
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
getFirestore,
collection,
addDoc,
doc,
getDoc,
setDoc,
updateDoc,
deleteDoc,
onSnapshot,
query,
where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyC6t4mzE936TCxWNdN9VbS5m-YT-kCXjyw",
authDomain:"task-f5475.firebaseapp.com",
projectId:"task-f5475",
storageBucket:"task-f5475.firebasestorage.app",
messagingSenderId:"466794970732",
appId:"1:466794970732:web:7eef2350e6d638dd6da249"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

await setPersistence(auth,browserSessionPersistence);

let myData=null;

const loginBox=document.getElementById("login");
const appArea=document.getElementById("appArea");

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,password.value);
};

window.signup=async()=>{

try{

const cred=await createUserWithEmailAndPassword(auth,joinEmail.value,joinPassword.value);

await setDoc(doc(db,"users",cred.user.uid),{
name:userName.value,
email:joinEmail.value,
role:"staff",
approved:false,
createdAt:new Date()
});

alert("가입 완료 / 관리자 승인 필요");

await signOut(auth);

}catch(e){

if(e.code==="auth/email-already-in-use"){
alert("이미 가입된 이메일입니다");
}else{
alert("가입 실패");
console.error(e);
}

}

};

onAuthStateChanged(auth,async(user)=>{

if(!user){
loginBox.style.display="block";
appArea.style.display="none";
return;
}

const ref=doc(db,"users",user.uid);
const snap=await getDoc(ref);

if(!snap.exists()){

 await setDoc(ref,{
  name:user.displayName || user.email,
  email:user.email,
  role:"staff",
  approved:false,
  createdAt:new Date()
 });

 alert("사용자 등록됨 / 관리자 승인 필요");
 await signOut(auth);
 return;

}

myData=snap.data();

if(myData.approved!==true){
alert("관리자 승인 대기");
await signOut(auth);
return;
}

startApp();

});

function startApp(){

loginBox.style.display="none";
appArea.style.display="block";

logoutArea.innerHTML=`<button onclick="logout()">로그아웃</button>`;

if(myData.role==="admin"){

adminTag.innerHTML="<span class='adminTag'>ADMIN</span>";
renderAdmin();

}else{

adminTag.innerHTML="";
adminPanel.innerHTML="";

}

loadTasks();
loadNotice();
enableDrag();

}

window.logout=()=>signOut(auth);

function renderAdmin(){

adminPanel.innerHTML=`

<h3>관리자</h3>

<button onclick="openTaskModal()">업무 추가</button>
<button onclick="addNotice()">공지 작성</button>

<h3>가입 승인</h3>
<div id="approveList"></div>

`;

loadApprove();
loadStaffList();

}

function loadApprove(){

onSnapshot(collection(db,"users"),snap=>{

approveList.innerHTML="";

snap.forEach(u=>{

const d=u.data();

if(d.approved!==true){

approveList.innerHTML+=`
<div>
${d.name} (${d.email})
<button onclick="approve('${u.id}')">승인</button>
</div>
`;

}

});

});

}

window.approve=async(uid)=>{
await updateDoc(doc(db,"users",uid),{approved:true});
};

function loadStaffList(){

onSnapshot(collection(db,"users"),snap=>{

staffSelect.innerHTML="";

snap.forEach(u=>{

const d=u.data();

if(d.role==="staff" && d.approved===true){
staffSelect.innerHTML+=`<option>${d.name}</option>`;
}

});

});

}

window.openTaskModal=()=>{
taskModal.style.display="flex";
};

window.closeModal=()=>{
taskModal.style.display="none";
};

window.createTask=async()=>{

const text=taskText.value;
const staff=staffSelect.value;

if(!text) return;

await addDoc(collection(db,"tasks"),{
text,
staff,
status:"todo",
createdAt:new Date()
});

taskText.value="";
taskModal.style.display="none";

};

window.addNotice=async()=>{

const text=prompt("공지");

if(!text) return;

await addDoc(collection(db,"notice"),{
text,
createdAt:new Date()
});

};

function loadTasks(){

let q;

if(myData.role==="admin"){
q = collection(db,"tasks");
}else{
q = query(collection(db,"tasks"), where("staff","==",myData.name));
}

onSnapshot(q,snap=>{

todo.innerHTML="";
done.innerHTML="";

snap.forEach(d=>{

const data=d.data();
const id=d.id;

const div=document.createElement("div");
div.className="card";
div.draggable=true;
div.dataset.id=id;

div.innerHTML=`
${data.text}<br>
담당: ${data.staff}
`;

if(myData.role==="admin" && data.status==="done"){
div.innerHTML+=`<br><button onclick="removeTask('${id}')">삭제</button>`;
}

if(data.status==="todo") todo.appendChild(div);
if(data.status==="done") done.appendChild(div);

});

});

}

window.removeTask=async(id)=>{
await deleteDoc(doc(db,"tasks",id));
};

window.deleteNotice=async(id)=>{
await deleteDoc(doc(db,"notice",id));
};

function loadNotice(){

onSnapshot(collection(db,"notice"),snap=>{

noticeArea.innerHTML="";

snap.forEach(n=>{

const d=n.data();
const id=n.id;

const div=document.createElement("div");
div.className="notice";

div.innerHTML=`
${d.text}
${myData.role==="admin"
? `<br><button onclick="deleteNotice('${id}')">삭제</button>`
: ``}
`;

noticeArea.appendChild(div);

});

});

}

function enableDrag(){

document.addEventListener("dragstart",e=>{

if(!e.target.classList.contains("card")) return;

e.dataTransfer.setData("id",e.target.dataset.id);

});

document.querySelectorAll(".column").forEach(col=>{

col.addEventListener("dragover",e=>{
e.preventDefault();
});

col.addEventListener("drop",async e=>{

const id=e.dataTransfer.getData("id");
const status=col.dataset.status;

await updateDoc(doc(db,"tasks",id),{status});

});

});

}

</script>
</body>
</html>
