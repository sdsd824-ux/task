<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>업무포털</title>

<style>

body{
font-family:Arial;
margin:0;
background:#f4f6fb;
}

header{
background:#1f2a44;
color:white;
padding:14px;
font-size:20px;
font-weight:bold;
display:flex;
justify-content:space-between;
align-items:center;
}

.container{
padding:20px;
}

.board{
display:flex;
gap:20px;
overflow-x:auto;
}

.column{
background:white;
border-radius:10px;
padding:15px;
width:320px;
box-shadow:0 3px 10px rgba(0,0,0,0.1);
min-height:400px;
}

.card{
background:#eef1f8;
padding:10px;
border-radius:8px;
margin-bottom:10px;
cursor:grab;
}

button{
border:none;
padding:6px 10px;
border-radius:6px;
cursor:pointer;
}

.loginBox{
max-width:400px;
margin:80px auto;
background:white;
padding:30px;
border-radius:10px;
box-shadow:0 5px 20px rgba(0,0,0,0.1);
}

input,select{
width:100%;
padding:10px;
margin-bottom:10px;
}

.notice{
background:white;
padding:10px;
margin-bottom:10px;
border-radius:8px;
}

.adminTag{
background:#111827;
padding:4px 8px;
border-radius:6px;
margin-left:10px;
}

</style>
</head>

<body>

<header>
<div>
업무포털
<span id="adminTag"></span>
</div>

<div id="logoutArea"></div>
</header>

<div id="login" class="loginBox">

<h2>로그인</h2>

<input id="email" placeholder="이메일">
<input id="password" type="password" placeholder="비밀번호">
<button onclick="login()">로그인</button>

<hr>

<h3>회원가입</h3>

<input id="name" placeholder="이름">
<input id="joinEmail" placeholder="이메일">
<input id="joinPassword" type="password" placeholder="비밀번호">
<button onclick="signup()">가입</button>

</div>

<div id="appArea" style="display:none">

<div class="container">

<div id="adminPanel"></div>

<h3>공지</h3>
<div id="noticeArea"></div>

<div class="board">

<div class="column" data-status="todo">
<h2>진행</h2>
<div id="todo"></div>
</div>

<div class="column" data-status="done">
<h2>완료</h2>
<div id="done"></div>
</div>

</div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getAuth,
signInWithEmailAndPassword,
createUserWithEmailAndPassword,
onAuthStateChanged,
signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
getFirestore,
collection,
addDoc,
doc,
getDoc,
setDoc,
updateDoc,
deleteDoc,
onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {

apiKey: "너꺼",
authDomain: "너꺼",
projectId: "너꺼",
appId: "너꺼"

};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore();

let me=null;
let myData=null;

const loginBox=document.getElementById("login");
const appArea=document.getElementById("appArea");

window.login=async()=>{

await signInWithEmailAndPassword(
auth,
email.value,
password.value
);

};

window.signup=async()=>{

const cred=await createUserWithEmailAndPassword(
auth,
joinEmail.value,
joinPassword.value
);

await setDoc(doc(db,"users",cred.user.uid),{

name:name.value,
email:joinEmail.value,
role:"staff",
approved:false

});

alert("가입완료 / 관리자 승인 필요");

};

onAuthStateChanged(auth,async(user)=>{

if(!user){
loginBox.style.display="block";
appArea.style.display="none";
return;
}

me=user;

const snap=await getDoc(doc(db,"users",user.uid));

myData=snap.data();

if(!myData.approved){
alert("관리자 승인 대기");
await signOut(auth);
return;
}

startApp();

});

function startApp(){

loginBox.style.display="none";
appArea.style.display="block";

logoutArea.innerHTML=`<button onclick="logout()">로그아웃</button>`;

if(myData.role==="admin"){

adminTag.innerHTML="관리자";
renderAdmin();

}

loadTasks();
loadNotice();
enableDrag();

}

window.logout=()=>{

signOut(auth);

};

function renderAdmin(){

adminPanel.innerHTML=`

<h3>관리자</h3>

<button onclick="addTask()">업무 추가</button>
<button onclick="addNotice()">공지 작성</button>

<h3>가입 승인</h3>
<div id="approveList"></div>

`;

loadApprove();

}

function loadApprove(){

onSnapshot(collection(db,"users"),snap=>{

approveList.innerHTML="";

snap.forEach(u=>{

const d=u.data();

if(!d.approved){

approveList.innerHTML+=`
<div>
${d.name}
<button onclick="approve('${u.id}')">승인</button>
</div>
`;

}

});

});

}

window.approve=async(uid)=>{

await updateDoc(doc(db,"users",uid),{
approved:true
});

};

window.addTask=async()=>{

const text=prompt("업무");

const staff=prompt("담당자 이름");

if(!text) return;

await addDoc(collection(db,"tasks"),{

text,
staff,
status:"todo"

});

};

window.addNotice=async()=>{

const text=prompt("공지");

await addDoc(collection(db,"notice"),{
text
});

};

function loadTasks(){

onSnapshot(collection(db,"tasks"),snap=>{

todo.innerHTML="";
done.innerHTML="";

snap.forEach(d=>{

const data=d.data();
const id=d.id;

const div=document.createElement("div");

div.className="card";
div.draggable=true;
div.dataset.id=id;

div.innerHTML=`
${data.text}<br>
담당: ${data.staff}
`;

if(myData.role==="admin" && data.status==="done"){

div.innerHTML+=`<br><button onclick="removeTask('${id}')">삭제</button>`;

}

if(data.status==="todo") todo.appendChild(div);
if(data.status==="done") done.appendChild(div);

});

});

}

window.removeTask=async(id)=>{

await deleteDoc(doc(db,"tasks",id));

};

function loadNotice(){

onSnapshot(collection(db,"notice"),snap=>{

noticeArea.innerHTML="";

snap.forEach(n=>{

const d=n.data();

const div=document.createElement("div");

div.className="notice";
div.innerText=d.text;

noticeArea.appendChild(div);

});

});

}

function enableDrag(){

document.addEventListener("dragstart",e=>{
e.dataTransfer.setData("id",e.target.dataset.id);
});

document.querySelectorAll(".column").forEach(col=>{

col.addEventListener("dragover",e=>{
e.preventDefault();
});

col.addEventListener("drop",async e=>{

const id=e.dataTransfer.getData("id");
const status=col.dataset.status;

await updateDoc(doc(db,"tasks",id),{
status
});

});

});

}

</script>
</body>
</html>
